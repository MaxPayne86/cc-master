
/*
************************************************************************************************************************
*       INCLUDE FILES
************************************************************************************************************************
*/

#include "device.h"


/*
************************************************************************************************************************
*       INTERNAL MACROS
************************************************************************************************************************
*/

// device status
enum {DEV_WAITING_HANDSHAKE, DEV_WAITING_DESCRIPTOR};


/*
************************************************************************************************************************
*       INTERNAL CONSTANTS
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       INTERNAL DATA TYPES
************************************************************************************************************************
*/

typedef struct cc_dev_descriptor_t {
    string_t label;
    uint8_t actuators_count;
} cc_dev_descriptor_t;

typedef struct cc_device_t {
    int id, status;
    cc_dev_descriptor_t descriptor;
} cc_device_t;


/*
************************************************************************************************************************
*       INTERNAL GLOBAL VARIABLES
************************************************************************************************************************
*/

static cc_device_t g_devices[CC_MAX_DEVICES];


/*
************************************************************************************************************************
*       INTERNAL FUNCTIONS
************************************************************************************************************************
*/


/*
************************************************************************************************************************
*       GLOBAL FUNCTIONS
************************************************************************************************************************
*/

int device_handshake(void)
{
    // get next free device
    for (int i = 0; i < CC_MAX_DEVICES; i++)
    {
        if (g_devices[i].status == DEV_WAITING_HANDSHAKE)
        {
            g_devices[i].id = i + 1;
            g_devices[i].status++;
            return g_devices[i].id;
        }
    }

    return -1;
}

int device_add(cc_msg_t *msg)
{
    int idx = msg->dev_address - 1;

    if (g_devices[idx].status == DEV_WAITING_DESCRIPTOR)
    {
        g_devices[idx].status++;
    }

    return -1;
}
